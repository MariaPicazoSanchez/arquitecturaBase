<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Gestión de Usuarios</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='28'/%3E%3Ctext x='32' y='38' font-size='28' text-anchor='middle' fill='white'%3EA%3C/text%3E%3C/svg%3E">


  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>


  <!-- jQuery -->
  <!-- <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script> -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>

  <!-- SDK de Google Identity -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <!-- <script>
    window.onload = function () {
      const CLIENT_ID = "1066426825741-14bm07md25p7l7b8bnbmile9oeqrivl5.apps.googleusercontent.com"; 
      const LOGIN_URI = "http://localhost:3000/oneTap/callback";

      // inicializa One Tap
      try {
        google.accounts.id.initialize({
          client_id: CLIENT_ID,
          login_uri: LOGIN_URI,
          auto_select: false
        });
        google.accounts.id.prompt((n) => {
          const mt = n.getMomentType?.();
          const nd = n.getNotDisplayedReason?.();
          const sk = n.getSkippedReason?.();
          console.log('OneTap:', { moment: mt, notDisplayed: nd, skipped: sk });
          const box = document.getElementById('onetap-status');
          if (box) box.textContent = `OneTap → moment=${mt} notDisplayed=${nd} skipped=${sk}`;
        });
      } catch (e) {
        console.error("GIS init error:", e);
        const box = document.getElementById('onetap-status');
        if (box) box.textContent = `GIS init error: ${e.message}`;
      }
    }
  </script> -->

  <div id="onetap-status" style="font:12px/1.2 sans-serif; color:#666; margin-top:8px;"></div>


  <!-- Incluir Popper.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"></script>

  <!-- Tus scripts -->
  <script src="./clienteRest.js"></script>
  <script src="./controlWeb.js"></script>
</head>
<body>
  <nav class="navbar navbar-expand-sm bg-dark navbar-dark">
    <!-- Brand/logo -->
    <a class="navbar-brand" href="#">Usuario</a>

    <!-- Links -->
    <ul class="navbar-nav">
        <li class="nav-item">
            <a class="nav-link" href="#" id="menuAgregarUsuario">AgregarUsuario</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="#" id="menuListarUsuarios">Listar Usuarios</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="#" id="">Link 3</a>
        </li>
    </ul>
  </nav>


  <div class="container mt-4">
      <h1 class="mb-3">Gestión de Usuarios</h1>
      <div id="au"></div>
  </div>
  <!-- One Tap: configuración -->
  <script src="/config.js"></script>
  <script>
    // Espera a que el SDK y la configuración estén disponibles, luego inicializa One Tap
    (function initGIS(){
      if (typeof window.APP_CONFIG === 'undefined' || !window.APP_CONFIG.CLIENT_ID) {
        setTimeout(initGIS, 100);
        return;
      }
      // Evitar mostrar One Tap si ya hay cookie 'nick' (usuario ya logueado)
      try {
        const hasNick = (window.jQuery && $.cookie && $.cookie('nick')) || document.cookie.split(';').map(s=>s.trim()).some(s=>s.indexOf('nick=')===0);
        if (hasNick) return;
      } catch(e) {}
      // Evitar inicializar/mostrar prompt más de una vez
      if (window._oneTapInitialized) return;
      window._oneTapInitialized = true;
      // SDK se carga asíncronamente, comprobamos su disponibilidad
      if (window.google && google.accounts && google.accounts.id) {
        try {
          google.accounts.id.initialize({
            client_id: window.APP_CONFIG.CLIENT_ID,
            // Recibimos credential en el cliente y lo enviamos al servidor
            callback: function(response){
              try { google.accounts.id.cancel(); } catch(e){}
              try {
                fetch('/oneTap/callback', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(response),
                  credentials: 'same-origin'
                }).then(r => { if (r.redirected) window.location = r.url; }).catch(e => console.error('[GSI] error enviando credential:', e));
              } catch(e) { console.error('[GSI] callback error:', e); }
            },
            auto_select: false
          });
          // Mostrar prompt (sin callbacks debug)
          google.accounts.id.prompt();
        } catch (e) {
          console.error('Error inicializando Google Identity:', e);
        }
      } else {
        setTimeout(initGIS, 100);
      }
    })();
  </script>
  

  <script>
    window.rest = new ClienteRest();
    window.cw = new ControlWeb();
    
    $(document).ready(function() {
        cw.comprobarSesion();
        
        $('#menuAgregarUsuario').click(function() {
            cw.mostrarAgregarUsuario();
        });
        
        $('#menuListarUsuarios').click(function() {
            cw.mostrarListaUsuarios();
        });

    });
  </script>

  <div class="container">
    <!-- <h3>Sistema</h3> -->
    <div id="au"></div>
    <div id="registro"></div>
    <div id="msg"></div>
  </div>

<!-- Solo cargas de librerías y tus JS, sin código inline -->
<!-- <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="./client/lib/jquery.cookie.js"></script>
<script src="./client/controlWeb.js"></script>
<script src="./client/clienteRest.js"></script> -->

</body>
</html>
